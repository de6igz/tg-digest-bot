# Бизнес-логика сервиса биллинга

Документ описывает автономный сервис биллинга на уровне системы: его ответственность, модель данных, интеграции и правила взаимодействия с другими компонентами.

## Основные обязанности

Сервис биллинга владеет балансами пользователей, счетами и платежами. Он предоставляет HTTP API, к которому обращаются bot-gateway и публичное API, а также интегрируется с банком Точка для генерации SBP QR-кодов и приёма вебхуков. Внутри сервиса нет зависимостей от tg-digest-bot, взаимодействие происходит исключительно через его API.【F:billing/cmd/billing/main.go†L17-L80】【F:billing/internal/http/server.go†L48-L109】

## Доменные модели

Ядро домена разделяется между сервисом биллинга и его клиентами:

- **Money** хранит сумму в минорных единицах и код валюты. При отсутствии значения в ответах Точки или базе данных валюта нормализуется в RUB.【F:billing/internal/domain/billing.go†L16-L44】【F:billing/internal/storage/postgres.go†L17-L70】
- **BillingAccount** описывает баланс пользователя. Аккаунт создаётся лениво для каждого пользователя и содержит текущий баланс, временные метки и валюту.【F:billing/internal/domain/billing.go†L18-L33】【F:billing/internal/storage/postgres.go†L26-L70】
- **Invoice** фиксирует счёт к оплате: сумму, описание и/или метаданные, статус и идемпотентный ключ. В метаданные может быть вложена информация о SBP QR-коде.【F:billing/internal/domain/billing.go†L35-L95】
- **Payment** отражает входящие и исходящие движения по счёту с привязкой к счёту/инвойсу, метаданными и временем завершения.【F:billing/internal/domain/billing.go†L97-L125】
- **InvoiceSBPMetadata** хранит данные QR-кода Точки (qrId, платёжную ссылку, payload, срок действия и провайдерские атрибуты) внутри счёта, чтобы переиспользовать уже выданный код без повторного обращения к Точке.【F:billing/internal/domain/billing.go†L72-L95】【F:billing/internal/usecase/sbp/service.go†L39-L90】

Все операции записи принимают идемпотентный ключ; хранилище гарантирует уникальность и при повторе возвращает существующую запись. Это защищает от дублей при повторных запросах или повторной доставке вебхуков.【F:billing/internal/storage/postgres.go†L72-L184】【F:billing/internal/storage/postgres.go†L200-L333】

## Хранилище и отдельная база данных

Сервис использует собственную базу данных Postgres, DSN которой передаётся через переменную окружения `BILLING_PG_DSN`. Она не разделяется с основным приложением и содержит только таблицы биллинга. Все инварианты инкапсулированы в адаптере Postgres, что позволяет остальным сервисам не иметь прямого доступа к базе.【F:billing/internal/config/config.go†L10-L34】【F:billing/cmd/billing/main.go†L21-L57】

Основные операции хранилища:

- `EnsureAccount` открывает транзакцию, создаёт или обновляет аккаунт по user_id и нормализует валюту, если в строке базы она отсутствует.【F:billing/internal/storage/postgres.go†L26-L80】
- `CreateInvoice` проверяет существование аккаунта, согласованность валюты, сериализует метаданные и вставляет новый инвойс. При конфликте идемпотентности перечитывает запись и сравнивает параметры запроса.【F:billing/internal/storage/postgres.go†L82-L164】
- `RegisterIncomingPayment` блокирует аккаунт (и инвойс, если он указан), проверяет валюту, создаёт завершённый платёж, увеличивает баланс и помечает счёт оплаченным при поступлении полной суммы. Частичные платежи отвергаются.【F:billing/internal/storage/postgres.go†L166-L289】
- `ChargeAccount` выполняет обратную операцию: проверяет достаточность баланса, вставляет отрицательный платёж и атомарно уменьшает баланс аккаунта.【F:billing/internal/storage/postgres.go†L291-L372】

Благодаря этим правилам клиенты воспринимают API биллинга как единственный источник истины без совместного подключения к БД.

## HTTP API

HTTP-сервер предоставляет REST-подобные эндпоинты для доменных операций. Основные маршруты:

- `POST /api/v1/accounts/ensure` и `GET /api/v1/accounts/by-user/{id}` для создания и получения аккаунтов.【F:billing/internal/http/server.go†L57-L138】
- `POST /api/v1/accounts/charge` для идемпотентного списания; бизнес-ошибки (например, недостаточно средств) возвращаются в структурированном виде.【F:billing/internal/http/server.go†L112-L182】
- `POST /api/v1/invoices`, `GET /api/v1/invoices/{id}` и `/api/v1/invoices/idempotency/{key}` для создания и чтения счётов.【F:billing/internal/http/server.go†L184-L236】
- `POST /api/v1/payments/incoming` для регистрации не-SBP пополнений (например, ручных).【F:billing/internal/http/server.go†L238-L272】
- `POST /api/v1/sbp/invoices` для запроса SBP QR-кода в банке Точка и `POST /api/v1/sbp/webhook` для обработки входящих вебхуков. Эти маршруты доступны только при настроенных креденшлах Точки.【F:billing/internal/http/server.go†L274-L347】【F:billing/internal/http/server.go†L349-L406】

Каждый хендлер валидирует входные данные, мапит доменные ошибки в HTTP-статусы и сериализует доменные сущности обратно в JSON, обеспечивая консистентный контракт для потребителей.【F:billing/internal/http/server.go†L57-L406】

## Процесс выпуска SBP-счёта

При вызове `POST /api/v1/sbp/invoices` сервер делегирует работу use case’у SBP:

1. Провалидировать запрос (пользователь, сумма, идемпотентный ключ) и проставить дефолты, например URL уведомлений из конфигурации Точки.【F:billing/internal/http/server.go†L274-L336】【F:billing/internal/usecase/sbp/service.go†L34-L67】
2. Проверить наличие инвойса по идемпотентному ключу и, если он есть, вернуть сохранённые метаданные Точки без повторного обращения во внешний API.【F:billing/internal/usecase/sbp/service.go†L48-L80】
3. Убедиться в наличии аккаунта пользователя, нормализовать валюту и подготовить запрос регистрации QR-кода. Так как API Точки не принимает `order_id`, передаются только сумма, описание, назначение платежа, тип QR, URL вебхука и дополнительные поля клиента.【F:billing/internal/usecase/sbp/service.go†L82-L114】【F:billing/internal/tochka/client.go†L40-L120】
4. Вызвать Точку, распарсить `qrId`, платёжную ссылку, payload’ы, статус и срок действия, а затем сохранить полный ответ провайдера в метаданные счёта для идемпотентности повторов.【F:billing/internal/tochka/client.go†L122-L196】【F:billing/internal/usecase/sbp/service.go†L116-L142】
5. Создать инвойс в Postgres с привязанными SBP-данными и вернуть его вместе с QR-кодом клиенту.【F:billing/internal/usecase/sbp/service.go†L138-L157】

Хранимые метаданные (включая `qrId`) позволяют связать будущий вебхук с нужным счётом, несмотря на отсутствие `order_id` в ответах регистрации и уведомлениях Точки.【F:billing/internal/usecase/sbp/service.go†L48-L157】【F:billing/internal/tochka/webhook.go†L34-L116】

## Обработка SBP-вебхуков

Хендлер вебхука проверяет настроенный shared secret или JWT-подпись (если Точка подписывает уведомления), парсит тело в нормализованный формат и передаёт его в use case для проведения платежа.【F:billing/internal/http/server.go†L349-L406】【F:billing/internal/tochka/jwt.go†L19-L170】

Use case выполняет следующие шаги:

1. Требует наличие `qrId`, который однозначно сопоставляет вебхук с идемпотентным ключом счёта; без него уведомление отвергается.【F:billing/internal/usecase/sbp/service.go†L146-L152】
2. Ищет инвойс по `qrId` и конвертирует сумму в минорные единицы с помощью вспомогательных функций Точки.【F:billing/internal/usecase/sbp/service.go†L152-L166】【F:billing/internal/tochka/webhook.go†L96-L116】
3. Формирует метаданные платежа (статус, назначение, данные плательщика, сырое тело) и регистрирует входящий платёж через репозиторий. Поле `order_id` добавляется только если пришло от Точки, поддерживая кейсы без него.【F:billing/internal/usecase/sbp/service.go†L166-L201】
4. Хранилище зачисляет баланс, помечает счёт оплаченным при совпадении суммы и возвращает завершённый платёж.【F:billing/internal/storage/postgres.go†L166-L289】

Идемпотентные ключи для платежей строятся на основе идентификаторов из вебхука: в первую очередь используется Tochka payment ID, далее event ID, и `qrId` как последний fallback. Это гарантирует защиту от дублей даже при отсутствии необязательных полей в уведомлениях.【F:billing/internal/tochka/webhook.go†L96-L116】

## Сводная последовательность

1. Клиент убеждается, что у пользователя есть аккаунт, и запрашивает SBP-инвойс через API биллинга.
2. Сервис обращается к Точке за QR-кодом, сохраняет инвойс с SBP-метаданными и возвращает данные клиенту.
3. Пользователь оплачивает счёт по QR-коду; Точка отправляет вебхук в сервис биллинга.
4. Вебхук валидируется, нормализуется и регистрируется как входящий платёж, что зачисляет средства и помечает счёт оплаченным.

Благодаря строгой идемпотентности и хранению метаданных сервис устойчив к повторным запросам на каждом шаге и изолирует детали интеграции с Точкой от остальных компонентов системы.【F:billing/internal/usecase/sbp/service.go†L34-L201】【F:billing/internal/storage/postgres.go†L72-L372】
